

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>VALIS &mdash; valis &#34;1.0.0rc5&#34;
 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Registration" href="registration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="#">
          

          
            
            <img src="_static/valis_logo_black_no_bg.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="registration.html">Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="slide_io.html">Slide I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="preprocessing.html">Image pre-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="feature_detectors.html">Feature detectors and descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="feature_matcher.html">Feature matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="affine_optimizer.html">Affine optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="non_rigid_registrars.html">Non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="serial_rigid.html">Serial rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="serial_non_rigid.html">Serial non-rigid registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="viz.html">Visualization</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">valis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
        
      <li>VALIS</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="valis">
<h1>VALIS<a class="headerlink" href="#valis" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://valis.readthedocs.io/en/latest/?badge=latest"><img alt="Documentation Status" src="https://readthedocs.org/projects/valis/badge/?version=latest" /></a> <a class="reference external" href="https://github.com/MathOnco/valis/actions?workflow=CI"><img alt="CI Status" src="https://github.com/MathOnco/valis/workflows/CI/badge.svg?branch=main" /></a> <a class="reference external" href="https://badge.fury.io/py/valis-wsi"><img alt="pypi" src="https://badge.fury.io/py/valis-wsi.svg" /></a></p>
<img alt="https://github.com/MathOnco/valis/raw/main/docs/_images/banner.gif" src="https://github.com/MathOnco/valis/raw/main/docs/_images/banner.gif" />
<p>VALIS, which stands for Virtual Alignment of pathoLogy Image Series, is a fully automaated pipeline to register whole slide images (WSI) using rigid and/or non-rigid transformtions. A full description of the method is descriped in the paper by <a class="reference external" href="https://www.biorxiv.org/content/10.1101/2021.11.09.467917v1">Gatenbee et al. 2021</a>. VALIS uses <a class="reference external" href="https://www.openmicroscopy.org/bio-formats/">Bio-Formats</a>, <a class="reference external" href="https://openslide.org/">OpenSlide</a>, <a class="reference external" href="https://www.libvips.org/">libvips</a>, and <a class="reference external" href="https://scikit-image.org/">scikit-image</a> to read images and slides, and so is able to work with a wide variety of formats. Registered images can be saved as <a class="reference external" href="https://docs.openmicroscopy.org/ome-model/5.6.3/ome-tiff/">ome.tiff</a> slides that can be used in downstream analyses. ome.tiff format is opensource and widely supported, being readable in several different programming languages (Python, Java, Matlab, etc…) and software, such as <a class="reference external" href="https://qupath.github.io/">QuPath</a>, <a class="reference external" href="https://indicalab.com/halo/">HALO by Idica Labs</a>, etc…</p>
<dl>
<dt>The registration pipeline is fully automated and goes as follows:</dt><dd><blockquote>
<div><img alt="https://github.com/MathOnco/valis/raw/main/docs/_images/pipeline.png" src="https://github.com/MathOnco/valis/raw/main/docs/_images/pipeline.png" />
</div></blockquote>
<ol class="arabic">
<li><p>Images/slides are converted to numpy arrays. As WSI are often too large to fit into memory, these images are usually lower resolution images from different pyramid levels.</p></li>
<li><p>Images are processed to single channel images. They are then normalized to make them look as similar as possible.</p></li>
<li><p>Image features are detected and then matched between all pairs of image.</p></li>
<li><p>If the order of images is unknown, they will be optimally ordered based on their feature similarity</p></li>
<li><p>Images will be aligned <em>towards</em> (not to) a reference image. If the reference image was not specified, it will automatically be set to the image at the center of the stack.</p></li>
<li><p>Rigid registration is performed serially, with each image being rigidly aligned towards the reference image. That is, if the reference image is the 5th in the stack, image 4 will be aligned to 5 (the reference), and then 3 will be aligned to the now registered version of 4, and so on. VALIS uses feature detection to match and align images, but one can optionally perform a final step that maximizes the mutual information betweeen each pair of images.</p></li>
<li><p>Non-rigid registration is then performed either by:</p>
<blockquote>
<div><ul class="simple">
<li><p>aliging each image towards the reference image following the same sequence used during rigid registation.</p></li>
<li><p>using groupwise registration that non-rigidly aligns the images to a common frame of reference. Currently this is only possible if <a class="reference external" href="https://simpleelastix.github.io">SimpleElastix</a> is installed.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Error is measured by calculating the distance between registered matched features in the full resolution images.</p></li>
</ol>
</dd>
</dl>
<p>The transformations found by VALIS can then be used to warp the full resolution slides. It is also possible to merge non-RGB registered slides to create a highly multiplexed image. These aligned and/or merged slides can then be saved as ome.tiff images.</p>
<p>In addition to warping images and slides, VALIS can also warp point data, such as cell centoids or ROI coordinates.</p>
<p>Full documentation can be found at <a class="reference external" href="https://valis.readthedocs.io/en/latest/">ReadTheDocs</a>.</p>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#installation" id="id4">Installation</a></p></li>
<li><p><a class="reference internal" href="#examples" id="id5">Examples</a></p></li>
<li><p><a class="reference internal" href="#change-log" id="id6">Change Log</a></p></li>
<li><p><a class="reference internal" href="#docmentation" id="id7">Docmentation</a></p></li>
<li><p><a class="reference internal" href="#indices-and-tables" id="id8">Indices and tables</a></p></li>
</ul>
</div>
<section id="installation">
<h2><a class="toc-backref" href="#id4">Installation</a><a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>VALIS requires Python &gt;=3.7</p>
</div>
<section id="conda-recommened-for-non-windows-users">
<h3>conda (recommened for non-Windows users)<a class="headerlink" href="#conda-recommened-for-non-windows-users" title="Permalink to this headline">¶</a></h3>
<p>VALIS will soon be available in the conda-forge channel of conda. However, unfortunately <a class="reference external" href="https://www.libvips.org/">libvips</a>, a  core dependency, is not yet available for Windows users on conda-forge.</p>
</section>
<section id="pip">
<h3>pip<a class="headerlink" href="#pip" title="Permalink to this headline">¶</a></h3>
<p>VALIS can be downloaded from PyPI as the <a class="reference external" href="https://pypi.org/project/valis-wsi/#description">valis-wsi</a> package using the pip command. However, VALIS requires several system level packages, which will need to be installed first.</p>
<section id="prerequisites">
<h4>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h4>
<p>VALIS uses Bioforamts to read many slide formats. Bioformats is written in Java, and VALIS uses the Python package jpype to access the Bioformats jar. Therefore, the user will need to have installed a Java Development Kit (JDK) containing the Java Runtime Environment (JRE):</p>
<ol class="arabic">
<li><p>Download appropriate JDK from <a class="reference external" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">java downloads</a></p></li>
<li><p>Edit your system and environment variables to update the Java home</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/libexec/java_home
</pre></div>
</div>
</li>
<li><p>Verify the path has been added:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="nv">$JAVA_HOME</span>
</pre></div>
</div>
<p>should print something like <code class="code docutils literal notranslate"><span class="pre">usr/libexec/java_home</span></code></p>
</li>
<li><p>(optional) If you will be working with files that have extensions: ‘.vmu’, ‘.mrxs’ ‘.svslide’, you will also need to install <a class="reference external" href="https://openslide.org">OpenSlide</a>. Note that this is not the same as openslide-python, which contains Python wrappers for OpenSlide.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>OpenSlide requires <a class="reference external" href="http://www.pixman.org">pixman</a>, which must be version 0.40.0. If pixman is a different version, then the slides may be distorted when reading from any pyramid level other than 0.</p>
</div>
</li>
<li><p>VALIS uses <a class="reference external" href="https://github.com/libvips/pyvips">pyvips</a> to warp and save the whole slide images (WSI) as ome.tiffs. Pyvips requires <a class="reference external" href="https://www.libvips.org/">libvips</a> (not a Python package) to be on your library search path, and so libvips must be installed separately. See the <a class="reference external" href="https://github.com/libvips/pyvips/blob/master/README.rst#non-conda-install">pyvips installation notes</a> for instructions on how to do this for your operating system. If you already have libvips installed, please make sure it’s version is &gt;= 8.11.</p></li>
</ol>
</section>
<section id="install">
<h4>Install<a class="headerlink" href="#install" title="Permalink to this headline">¶</a></h4>
<p>Once the above prerequisites have been satistifed, valis can be installed using pip, idealy within a virtual environment</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python3 -m venv venv_valis
$ <span class="nb">source</span> ./venv_valis/bin/activate
$ python3 -m pip install --upgrade pip
$ python3 pip install valis-wsi
</pre></div>
</div>
</section>
</section>
<section id="simpleelastix-optional">
<h3>SimpleElastix (optional)<a class="headerlink" href="#simpleelastix-optional" title="Permalink to this headline">¶</a></h3>
<p>The defaults used by VALIS work well, but VALIS also provides optional classes that require <a class="reference external" href="https://simpleelastix.github.io">SimpleElastix</a>. In particular, these classes are:</p>
<ol class="arabic simple">
<li><p>affine_optimizer.AffineOptimizerMattesMI, which uses sitk.ElastixImageFilter to simultaneously maximize Mattes Mutual Information and minimize the spatial distance between matched features.</p></li>
<li><p>non_rigid_registrars.SimpleElastixWarper, which uses sitk.ElastixImageFilter to find non-rigid transformations between pairs of images.</p></li>
<li><p>non_rigid_registrars.SimpleElastixGroupwiseWarper, which uses sitk.ElastixImageFilter to find non-rigid transformations using groupwise registration.</p></li>
</ol>
<p>To install SimpleElastix, you should probably uninstall the current version of SimpleITK in your environment, and then install SimpleElastix as described in the <a class="reference external" href="https://simpleelastix.readthedocs.io/GettingStarted.html">SimpleElastix docs</a>.</p>
</section>
</section>
<section id="examples">
<h2><a class="toc-backref" href="#id5">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Always be sure to always kill the JVM at the end of your script. Not doing so can prevent the software from closing. This can be accomplished by calling  either <code class="code docutils literal notranslate"><span class="pre">registration.kill_jvm()</span></code> or <code class="code docutils literal notranslate"><span class="pre">slide_io.kill_jvm()</span></code></p>
</div>
<section id="slide-registration">
<h3>Slide registration<a class="headerlink" href="#slide-registration" title="Permalink to this headline">¶</a></h3>
<img alt="https://github.com/MathOnco/valis/raw/main/docs/_images/challenging_dataset_adincar33.png" src="https://github.com/MathOnco/valis/raw/main/docs/_images/challenging_dataset_adincar33.png" />
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>One of the most imporant parameters used to initialize a Valis object is <code class="code docutils literal notranslate"><span class="pre">max_processed_image_dim_px</span></code>. The default value is 850, but if registration fails or is poor, try adjusting that value. Generally speaking, values between 500-2000 work well. In cases where there is little empty space, around the tissue, smaller values may be better. However, if there is a large amount of empty space/slide (as in the images above), larger values will be needed so that the tissue is at a high enough resolution. Finally, larger values can potentially generate more accurate registrations, but will be slower, require more memory, and won’t always produce better results.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If the order of slices is known and needs to be preserved, such as building a 3D image, set <code class="code docutils literal notranslate"><span class="pre">imgs_ordered=True</span></code> when intialzing the VALIS object. Otherwise, VALIS will sort the images based on similarity, which may or may not correspond on the sliced order. If using this option, be sure that the names of the files allow them to be sorted properly, e.g. 01.tiff, 02.tiff … 10.tiff, etc…</p>
</div>
<p>In this example, the slides that need to be registered are located in <code class="code docutils literal notranslate"><span class="pre">/path/to/slides</span></code>. This process simply involves the creation of a Valis object, which is what conducts the registration.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">valis</span> <span class="kn">import</span> <span class="n">registration</span>
<span class="n">slide_src_dir</span> <span class="o">=</span> <span class="s2">&quot;/path/to/slides&quot;</span>
<span class="n">results_dst_dir</span> <span class="o">=</span> <span class="s2">&quot;./slide_registration_example&quot;</span>
<span class="n">registered_slide_dst_dir</span> <span class="o">=</span> <span class="s2">&quot;./slide_registration_example/registered_slides&quot;</span>

<span class="c1"># Create a Valis object and use it to register the slides in slide_src_dir</span>
<span class="n">registrar</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">Valis</span><span class="p">(</span><span class="n">slide_src_dir</span><span class="p">,</span> <span class="n">results_dst_dir</span><span class="p">)</span>
<span class="n">rigid_registrar</span><span class="p">,</span> <span class="n">non_rigid_registrar</span><span class="p">,</span> <span class="n">error_df</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
</pre></div>
</div>
<p>After registration is complete, one can view the results to determine if they are acceptable. In this example, the results are located in  <code class="code docutils literal notranslate"><span class="pre">./slide_registration_example</span></code>. Inside this folder will be 6 subfolders:</p>
<ol class="arabic simple">
<li><p><strong>data</strong> contains 2 files:
* a summary spreadsheet of the alignment results, such as the registration error between each pair of slides, their dimensions, physical units, etc…</p>
<ul class="simple">
<li><p>a pickled version of the registrar. This can be reloaded (unpickled) and used later. For example, one could perfom the registration locally, but then use the pickled object to warp and save the slides on an HPC. Or, one could perform the registration and use the registrar later to warp points found in the (un-registered) slide.</p></li>
</ul>
</li>
<li><p><strong>overlaps</strong> contains thumbnails showing the how the images would look if stacked without being registered, how they look after rigid registration, and how they look after non-rigid registration. The rightmost images in the figure above provide examples of these overlap images.</p></li>
<li><p><strong>rigid_registration</strong> shows thumbnails of how each image looks after performing rigid registration. These would be similar to the bottom row in the figure above.</p></li>
<li><p><strong>non_rigid_registration</strong> shows thumbnaials of how each image looks after non-rigid registration. These would be similar to the bottom row in the figure above.</p></li>
<li><p><strong>deformation_fields</strong> contains images showing what the non-rigid deformation would do to a triangular mesh. These can be used to get a sense of how the images were altered by non-rigid warping. In these images, the color indicates the direction of the displacement, while brightness indicates it’s magnitude. These would be similar to those in the middle row in the figure above.</p></li>
<li><p><strong>processed</strong> shows thumnails of the processed images. These are thumbnails of the images that are actually used to perform the registration. The pre-processing and normalization methods should try to make these images look as similar as possible.</p></li>
</ol>
<p>If the results look good, then one can warp and save all of the slides as ome.tiffs. When saving the images, there are three cropping options:</p>
<ol class="arabic simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">crop=&quot;overlap&quot;</span></code> will crop the images to the region where all of the images overlap.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">crop=&quot;reference&quot;</span></code> will crop the images to the region where they overlap with the reference image</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">crop=&quot;all&quot;</span></code> will not perform any cropping. While this keep the all of the image, the dimensions of the registered image can be substantially larger than one that was cropped, as it will need to be large enough accomodate all of the other images.</p></li>
</ol>
<p>While the cropping setting can also be set when initializing the <code class="code docutils literal notranslate"><span class="pre">Valis</span></code> object, any of the above cropping methods can be used when saving the images.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save all registered slides as ome.tiff</span>
<span class="n">registrar</span><span class="o">.</span><span class="n">warp_and_save_slides</span><span class="p">(</span><span class="n">registered_slide_dst_dir</span><span class="p">,</span> <span class="n">crop</span><span class="o">=</span><span class="s2">&quot;overlap&quot;</span><span class="p">)</span>

<span class="c1"># Kill the JVM</span>
<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span>
</pre></div>
</div>
<p>The ome.tiff images can subsequently be used for downstream analysis, such as <a class="reference external" href="https://qupath.github.io/">QuPath</a></p>
<img alt="https://github.com/MathOnco/valis/raw/main/docs/_images/ome_tiff_zoom.png" src="https://github.com/MathOnco/valis/raw/main/docs/_images/ome_tiff_zoom.png" />
<p>One can also choose to save individual slides. This is accomplished by accessing the Slide object associated with a particular file, <code class="code docutils literal notranslate"><span class="pre">slide_f</span></code> and then “telling” it to save the slide aas <code class="code docutils literal notranslate"><span class="pre">out_f.ome.tiff</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">slide_obj</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">get_slide</span><span class="p">(</span><span class="n">slide_f</span><span class="p">)</span>
<span class="n">slide_obj</span><span class="o">.</span><span class="n">warp_and_save_slide</span><span class="p">(</span><span class="n">out_f</span><span class="o">.</span><span class="n">ome</span><span class="o">.</span><span class="n">tiff</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, if the non-rigid registration is deemed to have distored the image too much, one can apply only the rigid transformation by setting <code class="code docutils literal notranslate"><span class="pre">non_rigid=False</span></code> in <code class="code docutils literal notranslate"><span class="pre">slide_obj.warp_and_save_slide</span></code> or <code class="code docutils literal notranslate"><span class="pre">registrar.warp_and_save_slides</span></code>.</p>
</section>
<section id="slide-registration-and-merging">
<h3>Slide registration and merging<a class="headerlink" href="#slide-registration-and-merging" title="Permalink to this headline">¶</a></h3>
<p>Following registration, VALIS can merge the slides to create a single composite image. However, this should only be done for non-RGB images, such as multi/single-channel immunofluorescence images. An example would be slides of multiple CyCIF rounds. The user also has the option to provide channel names, but if not provided the channel names will become the “channel (filename)” given the channel name in the metadata. For example, if the file name is round1.ndpis then the DAPI channel name will be “DAPI (round1)”). In this example, the channel names are taken from the filename, which have the form “Tris CD20 FOXP3 CD3.ndpis”, “Tris CD4 CD68 CD3 1in25 ON.ndpis”, etc… The channel names need to be in a dictionary, where key=filename, value = list of channel names.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>By default, if a channel occurs in more than 1 image, only the 1st instance will be merged. For example, if DAPI is in all images, then only the DAPI channel of the 1st image will be in the resulting slide. This can be disabled by setting <code class="code docutils literal notranslate"><span class="pre">drop_duplicates=False</span></code> in <code class="code docutils literal notranslate"><span class="pre">warp_and_merge_slides</span></code></p>
</div>
<p>First, create a VALIS object and use it to register slides located in <code class="code docutils literal notranslate"><span class="pre">slide_src_dir</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">valis</span> <span class="kn">import</span> <span class="n">registration</span>
<span class="n">slide_src_dir</span> <span class="o">=</span> <span class="s2">&quot;/path/to/slides&quot;</span>
<span class="n">results_dst_dir</span> <span class="o">=</span> <span class="s2">&quot;./slide_merging_example&quot;</span>  <span class="c1"># Registration results saved here</span>
<span class="n">merged_slide_dst_f</span> <span class="o">=</span> <span class="s2">&quot;./slide_merging_example/merged_slides.ome.tiff&quot;</span>  <span class="c1"># Where to save merged slide</span>

<span class="n">registrar</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">Valis</span><span class="p">(</span><span class="n">slide_src_dir</span><span class="p">,</span> <span class="n">results_dst_dir</span><span class="p">)</span>
<span class="n">rigid_registrar</span><span class="p">,</span> <span class="n">non_rigid_registrar</span><span class="p">,</span> <span class="n">error_df</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
</pre></div>
</div>
<p>Check the results in <code class="code docutils literal notranslate"><span class="pre">results_dst_dir</span></code>, and if the look good merge and save the slide. Once complete, be sure to kill the JVM.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create function to extract channel names from the image.</span>
<span class="k">def</span> <span class="nf">cnames_from_filename</span><span class="p">(</span><span class="n">src_f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get channel names from file name</span>
<span class="sd">    Note that the DAPI channel is not part of the filename</span>
<span class="sd">    but is always the first channel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="n">valtils</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">src_f</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

<span class="n">channel_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span><span class="n">cnames_from_filename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">registrar</span><span class="o">.</span><span class="n">original_img_list</span><span class="p">}</span>
<span class="n">merged_img</span><span class="p">,</span> <span class="n">channel_names</span><span class="p">,</span> <span class="n">ome_xml</span> <span class="o">=</span> \
    <span class="n">registrar</span><span class="o">.</span><span class="n">warp_and_merge_slides</span><span class="p">(</span><span class="n">merged_slide_dst_f</span><span class="p">,</span>
                                    <span class="n">channel_name_dict</span><span class="o">=</span><span class="n">channel_name_dict</span><span class="p">,</span>
                                    <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span> <span class="c1"># Kill the JVM</span>
</pre></div>
</div>
<img alt="https://github.com/MathOnco/valis/raw/main/docs/_images/merge_ome_tiff.png" src="https://github.com/MathOnco/valis/raw/main/docs/_images/merge_ome_tiff.png" />
</section>
<section id="warping-points">
<h3>Warping points<a class="headerlink" href="#warping-points" title="Permalink to this headline">¶</a></h3>
<p>Once the registration parameters have been found, VALIS can be used to warp point data, such as cell coordinates, mask polygon vertices, etc… In this example, slides will be registered, and the registration parameters will then be used warp cell positions located in a separate .csv. This accomplished by accessing the <code class="code docutils literal notranslate"><span class="pre">Slide</span></code> object associated with each registered slide. This is done by passing the slide’s filename (with or without the extension) to <code class="code docutils literal notranslate"><span class="pre">registrar.get_slide</span></code>. This <code class="code docutils literal notranslate"><span class="pre">Slide</span></code> object can the be used to warp the individual slide and/or points associated with the un-registered slide. This can be useful in cases where one has already performed an analysis on the un-registered slides, as one can just warp the point data, as opposed to warping each slide and re-conducting the analysis.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>It is essential that the image from which the coordinates are derived has the same aspect ratio as the image used for registration. That is, the images used for registration must be scaled up/down versions of the image from which the coordinates are taken. For example, registration may be performed on lower resolution images (an upper image pyramid level), and applied to cell coordinates found by performing cell segmenation on the full resolution (pyramid level 0) image. The default is to assume that the points came from the highest resolution image, but this can be changed by setting <code class="code docutils literal notranslate"><span class="pre">pt_level</span></code> to either the pyramid level of the image the points originated, or its dimensions (width, height, in pixels). Also, the coordinates need to be in pixel units, not physical units. Finally, be sure that the coordinates are X,Y (column, row), with the origin being the top left corner of the image.</p>
</div>
<p>In this first example, cell segmentation and phenotyping has already been performed on the unregistered images. We can now use the <code class="code docutils literal notranslate"><span class="pre">Valis</span></code> object that performed the registration to warp the cell positions to their location in the registered images.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">valis</span> <span class="kn">import</span> <span class="n">registration</span>

<span class="n">slide_src_dir</span> <span class="o">=</span> <span class="s2">&quot;path/to/slides&quot;</span>
<span class="n">point_data_dir</span> <span class="o">=</span> <span class="s2">&quot;path/to/cell_positions&quot;</span>
<span class="n">results_dst_dir</span> <span class="o">=</span> <span class="s2">&quot;./point_warping_example&quot;</span>

<span class="c1"># Load a Valis object that has already registered the images.</span>
<span class="n">registrar_f</span> <span class="o">=</span> <span class="s2">&quot;path/to/results/data/registrar.pickle&quot;</span>
<span class="n">registrar</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">registrar_f</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>

<span class="c1"># Get .csv files containing cell coordinates</span>
<span class="n">point_data_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">point_data_dir</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.csv&quot;</span><span class="p">))</span>

<span class="c1"># Go through each file and warp the cell positions</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">point_data_list</span><span class="p">:</span>
    <span class="c1"># Get Slide object associated with the slide from which the point data originated</span>
    <span class="c1"># Point data and image have similar file names</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">corresponding_img</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">slide_obj</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">get_slide</span><span class="p">(</span><span class="n">corresponding_img</span><span class="p">)</span>

    <span class="c1"># Read data and calculate cell centroids (x, y)</span>
    <span class="n">points_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points_df</span><span class="p">[[</span><span class="s2">&quot;XMin&quot;</span><span class="p">,</span> <span class="s2">&quot;XMax&quot;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">points_df</span><span class="p">[[</span><span class="s2">&quot;YMin&quot;</span><span class="p">,</span> <span class="s2">&quot;YMax&quot;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Use Slide to warp the coordinates</span>
    <span class="n">warped_xy</span> <span class="o">=</span> <span class="n">slide_obj</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>

    <span class="c1"># Update dataframe with registered cell centroids</span>
    <span class="n">points_df</span><span class="p">[[</span><span class="s2">&quot;registered_x&quot;</span><span class="p">,</span> <span class="s2">&quot;registered_y&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">warped_xy</span>

    <span class="c1"># Save updated dataframe</span>
    <span class="n">pt_f_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;_registered.csv&quot;</span><span class="p">)</span>
    <span class="n">full_pt_f_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">results_dst_dir</span><span class="p">,</span> <span class="n">pt_f_out</span><span class="p">)</span>
    <span class="n">points_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">full_pt_f_out</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span> <span class="c1"># Kill the JVM</span>
</pre></div>
</div>
<p>Here is a comparison of before and after applying registration to cell positions found in the original un-aligned images:</p>
<img alt="https://github.com/MathOnco/valis/raw/main/docs/_images/point_warping.png" src="https://github.com/MathOnco/valis/raw/main/docs/_images/point_warping.png" />
<p>In this second example, a region of interest (ROI) was marked in one of the unregistered images, in this case “ihc_2.ome.tiff” . Using the <code class="code docutils literal notranslate"><span class="pre">Slide</span></code> object associated with “ihc_2.ome.tiff”, we can warp those ROI coordinates to their position in the registered images, and then use those to slice the registered ROI from each slide. Because VALIS uses pyvips to read and warp the slides, this process does not require the whole image to be loaded into memory and warped. As such, this is fast and does not require much memory. It’s also worth noting that because the points are being warped to the registred coordinate system, the slide that is the source of the ROI coordinates does not have to be the same slide that was treated as the reference image during registration.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">valis</span> <span class="kn">import</span> <span class="n">registration</span><span class="p">,</span> <span class="n">warp_tools</span>

<span class="c1"># Load a registrar that has already registered the images.</span>
<span class="n">registrar_f</span> <span class="o">=</span> <span class="s2">&quot;./expected_results/registration/ihc/data/ihc_registrar.pickle&quot;</span>
<span class="n">registrar</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">registrar_f</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>

<span class="c1"># Set the pyramid level from which the ROI coordinates originated. Usually 0 when working with slides.</span>
<span class="n">COORD_LEVEL</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># ROI coordinates, in microns. These came from the unregistered slide, &quot;ihc_2.ome.tiff&quot;</span>
<span class="n">bbox_xywh_um</span> <span class="o">=</span> <span class="p">[</span><span class="mi">14314</span><span class="p">,</span> <span class="mi">13601</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">]</span>
<span class="n">bbox_xy_um</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">bbox2xy</span><span class="p">(</span><span class="n">bbox_xywh_um</span><span class="p">)</span>

<span class="c1"># Get slide from which the ROI coordinates originated</span>
<span class="n">pt_source_img_f</span> <span class="o">=</span> <span class="s2">&quot;ihc_2.ome.tiff&quot;</span>
<span class="n">pt_source_slide</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">get_slide</span><span class="p">(</span><span class="n">pt_source_img_f</span><span class="p">)</span>

<span class="c1"># Convert coordinates to pixel units</span>
<span class="n">um_per_px</span> <span class="o">=</span> <span class="n">pt_source_slide</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">scale_physical_size</span><span class="p">(</span><span class="n">COORD_LEVEL</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">bbox_xy_px</span> <span class="o">=</span> <span class="n">bbox_xy_um</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">um_per_px</span><span class="p">)</span>

<span class="c1"># Warp coordinates to position in registered slides</span>
<span class="n">bbox_xy_in_registered_img</span> <span class="o">=</span> <span class="n">pt_source_slide</span><span class="o">.</span><span class="n">warp_xy</span><span class="p">(</span><span class="n">bbox_xy_px</span><span class="p">,</span>
                                                    <span class="n">slide_level</span><span class="o">=</span><span class="n">COORD_LEVEL</span><span class="p">,</span>
                                                    <span class="n">pt_level</span><span class="o">=</span><span class="n">COORD_LEVEL</span><span class="p">)</span>

<span class="n">bbox_xywh_in_registered_img</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">xy2bbox</span><span class="p">(</span><span class="n">bbox_xy_in_registered_img</span><span class="p">)</span>
<span class="n">bbox_xywh_in_registered_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">bbox_xywh_in_registered_img</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Create directory where images will be saved</span>
<span class="n">dst_dir</span> <span class="o">=</span> <span class="s2">&quot;./expected_results/roi&quot;</span>
<span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Warp each slide and slice the ROI from it using each pyips.Image&#39;s &quot;extract_area&quot; method.</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slide</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">registrar</span><span class="o">.</span><span class="n">slide_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
    <span class="n">warped_slide</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">warp_slide</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">COORD_LEVEL</span><span class="p">)</span>
    <span class="n">roi_vips</span> <span class="o">=</span> <span class="n">warped_slide</span><span class="o">.</span><span class="n">extract_area</span><span class="p">(</span><span class="o">*</span><span class="n">bbox_xywh_in_registered_img</span><span class="p">)</span>
    <span class="n">roi_img</span> <span class="o">=</span> <span class="n">warp_tools</span><span class="o">.</span><span class="n">vips2numpy</span><span class="p">(</span><span class="n">roi_vips</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">roi_img</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">slide</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="c1"># Only 5 images, so remove 6th subplot</span>
<span class="n">out_f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">registrar</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_roi.png&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_f</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Opening the slide initialized the JVM, so it needs to be killed</span>
<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span>
</pre></div>
</div>
<p>The extracted and registered ROI are shown below:</p>
<img alt="_images/ihc_roi.png" src="_images/ihc_roi.png" />
</section>
<section id="converting-slides-to-ome-tiff">
<h3>Converting slides to ome.tiff<a class="headerlink" href="#converting-slides-to-ome-tiff" title="Permalink to this headline">¶</a></h3>
<p>In addition to registering slide, VALIS can convert slides to ome.tiff, maintaining the original metadata. If the original is image is not RGB, the option <code class="code docutils literal notranslate"><span class="pre">perceputally_uniform_channel_colors=True</span></code> can be used to give each channel a perceptually uniform color, derived from the <a class="reference external" href="https://www.osapublishing.org/DirectPDFAccess/5166548C-BD18-487D-8601630F3A343883_368272/oe-25-13-15131.pdf?da=1&amp;id=368272&amp;seq=0&amp;mobile=no">JzAzBz</a> colorspace. An advantage of using perceptually uniform colors is that markers should appear brighter only if there is higher expression, not because the color (such as yellow) is perceived to be brighter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">valis</span> <span class="kn">import</span> <span class="n">slide_io</span>
<span class="n">slide_src_f</span> <span class="o">=</span> <span class="s2">&quot;path/to/slide</span>
<span class="n">converted_slide_f</span> <span class="o">=</span> <span class="s2">&quot;converted.ome.tiff&quot;</span>
<span class="n">slide_io</span><span class="o">.</span><span class="n">convert_to_ome_tiff</span><span class="p">(</span><span class="n">slide_src_f</span><span class="p">,</span>
                            <span class="n">converted_slide_f</span><span class="p">,</span>
                            <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">perceputally_uniform_channel_colors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">slide_io</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span>
</pre></div>
</div>
<img alt="https://github.com/MathOnco/valis/raw/main/docs/_images/pu_color_mplex.png" src="https://github.com/MathOnco/valis/raw/main/docs/_images/pu_color_mplex.png" />
</section>
<section id="using-non-defaults">
<h3>Using non-defaults<a class="headerlink" href="#using-non-defaults" title="Permalink to this headline">¶</a></h3>
<p>The defaults used by VALIS work well, but one may wish to try some other values/class, and/or create their own affine optimizer, feature detector, non-rigid registrar, etc… This examples shows how to conduct registration using non-default values</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example assumes that <a class="reference external" href="https://simpleelastix.readthedocs.io/GettingStarted.html">SimpleElastix</a> has been installed.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">valis</span> <span class="kn">import</span> <span class="n">registration</span><span class="p">,</span> <span class="n">feature_detectors</span><span class="p">,</span> <span class="n">non_rigid_registrars</span><span class="p">,</span> <span class="n">affine_optimizer</span>
<span class="n">slide_src_dir</span> <span class="o">=</span> <span class="s2">&quot;path/to/slides&quot;</span>
<span class="n">results_dst_dir</span> <span class="o">=</span> <span class="s2">&quot;./slide_registration_example_non_defaults&quot;</span>
<span class="n">registered_slide_dst_dir</span> <span class="o">=</span> <span class="s2">&quot;./slide_registration_example/registered_slides&quot;</span>


<span class="c1"># Select feature detector, affine optimizer, and non-rigid registration method.</span>
<span class="c1"># Will use KAZE for feature detection and description</span>
<span class="c1"># SimpleElastix will be used for non-rigid warping and affine optimization</span>
<span class="n">feature_detector_cls</span> <span class="o">=</span> <span class="n">feature_detectors</span><span class="o">.</span><span class="n">KazeFD</span>
<span class="n">non_rigid_registrar_cls</span> <span class="o">=</span> <span class="n">non_rigid_registrars</span><span class="o">.</span><span class="n">SimpleElastixWarper</span>
<span class="n">affine_optimizer_cls</span> <span class="o">=</span> <span class="n">affine_optimizer</span><span class="o">.</span><span class="n">AffineOptimizerMattesMI</span>

<span class="c1"># Create a Valis object and use it to register the slides in slide_src_dir</span>
<span class="n">registrar</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">Valis</span><span class="p">(</span><span class="n">slide_src_dir</span><span class="p">,</span> <span class="n">results_dst_dir</span><span class="p">,</span>
                        <span class="n">feature_detector_cls</span><span class="o">=</span><span class="n">feature_detector_cls</span><span class="p">,</span>
                        <span class="n">affine_optimizer_cls</span><span class="o">=</span><span class="n">affine_optimizer_cls</span><span class="p">,</span>
                        <span class="n">non_rigid_registrar_cls</span><span class="o">=</span><span class="n">non_rigid_registrar_cls</span><span class="p">)</span>


<span class="n">rigid_registrar</span><span class="p">,</span> <span class="n">non_rigid_registrar</span><span class="p">,</span> <span class="n">error_df</span> <span class="o">=</span> <span class="n">registrar</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>

<span class="n">registration</span><span class="o">.</span><span class="n">kill_jvm</span><span class="p">()</span> <span class="c1"># Kill the JVM</span>
</pre></div>
</div>
</section>
</section>
<section id="change-log">
<h2><a class="toc-backref" href="#id6">Change Log</a><a class="headerlink" href="#change-log" title="Permalink to this headline">¶</a></h2>
<section id="version-1-0-0rc5-april-5-2022">
<h3>Version 1.0.0rc5 (April 5, 2022)<a class="headerlink" href="#version-1-0-0rc5-april-5-2022" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Can provide a reference image that the others will be aligned towards. To do this, when initializinig the Valis object, set the <cite>reference_img_f</cite> argument to be the file name of the reference image. If not set by the user, the reference image will be set as the one at the center of the ordered image stack</p></li>
<li><p>Both non-rigid and rigid now align <em>towards</em> a reference image, meaning that reference image will have neither rigid nor non-rigid transformations applied to it.</p></li>
<li><p>Two cropping methods. First option is to crop seach registered slides to contain only the areas where all registered images overlap. The second option is to crop the registered slide to contain only the area that intersects with the reference image. It is also possible to not crop an image/slide.</p></li>
<li><p>Images are now cropped during the warp, not after, and so is now faster and requires less memory. For example, on a 2018 MacBook Pro with a 2.6 GHz Intel Core i7 processor, it takes 2-3 minutes to warp and save a 41399 x 43479 RGB image.</p></li>
<li><p>Warping of images and slides done using the same function, built around pyvips. Faster, more consistent, and should prevent excessive memory usage.</p></li>
<li><p>Fixed bug that caused a crash when warping large ome.tiff images.</p></li>
<li><p>Read slides and images using pyvips whenever possible.</p></li>
<li><p>Background color now automatically set to be same as the brightest (IHC) or darkest (IF) pixel in the image. Because of this, the “bg_color” argument in the slide warping functions was removed.</p></li>
<li><p>Reduced accumulation of unwanted non-rigid deformations</p></li>
<li><p>Displacement fields drawn ontop of non-rigid registered image to help determine where the deformations are happening.</p></li>
<li><p>If the slide has multiple series, and a series is not specficed, the slide reader will read the series containing the largest image.</p></li>
</ol>
</section>
<section id="license">
<h3>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="LICENSE.txt">MIT</a> © 2021-2022 Chandler Gatenbee</p>
</section>
</section>
<section id="docmentation">
<h2><a class="toc-backref" href="#id7">Docmentation</a><a class="headerlink" href="#docmentation" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="registration.html">Registration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="registration.html#valis">Valis</a></li>
<li class="toctree-l2"><a class="reference internal" href="registration.html#slide">Slide</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="slide_io.html">Slide I/O</a><ul>
<li class="toctree-l2"><a class="reference internal" href="slide_io.html#module-valis.slide_io">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="slide_io.html#classes">Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="slide_io.html#metadata">MetaData</a></li>
<li class="toctree-l3"><a class="reference internal" href="slide_io.html#slidereader">SlideReader</a></li>
<li class="toctree-l3"><a class="reference internal" href="slide_io.html#bioformatsslidereader">BioFormatsSlideReader</a></li>
<li class="toctree-l3"><a class="reference internal" href="slide_io.html#vipsslidereader">VipsSlideReader</a></li>
<li class="toctree-l3"><a class="reference internal" href="slide_io.html#flattenedpyramidreader">FlattenedPyramidReader</a></li>
<li class="toctree-l3"><a class="reference internal" href="slide_io.html#imagereader">ImageReader</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="preprocessing.html">Image pre-processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preprocessing.html#module-valis.preprocessing">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="preprocessing.html#classes">Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="preprocessing.html#base-imageprocesser">Base ImageProcesser</a></li>
<li class="toctree-l3"><a class="reference internal" href="preprocessing.html#channelgetter">ChannelGetter</a></li>
<li class="toctree-l3"><a class="reference internal" href="preprocessing.html#colorfulstandardizer">ColorfulStandardizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="preprocessing.html#luminosity">Luminosity</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="feature_detectors.html">Feature detectors and descriptors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="feature_detectors.html#module-valis.feature_detectors">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="feature_detectors.html#classes">Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#base-feature-detector">Base feature detector</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#brisk">BRISK</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#kaze">KAZE</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#akaze">AKAZE</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#daisy">DAISY</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#latch">LATCH</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#boost">BOOST</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#vgg">VGG</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_detectors.html#orb-vgg">Orb + Vgg</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="feature_matcher.html">Feature matching</a><ul>
<li class="toctree-l2"><a class="reference internal" href="feature_matcher.html#module-valis.feature_matcher">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="feature_matcher.html#classes">Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="feature_matcher.html#matchinfo">MatchInfo</a></li>
<li class="toctree-l3"><a class="reference internal" href="feature_matcher.html#matcher">Matcher</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="affine_optimizer.html">Affine optimization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="affine_optimizer.html#affineoptimizer">AffineOptimizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="affine_optimizer.html#affineoptimizermattesmi">AffineOptimizerMattesMI</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="non_rigid_registrars.html">Non-rigid registration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="non_rigid_registrars.html#base-nonrigidregistrar">Base NonRigidRegistrar</a></li>
<li class="toctree-l2"><a class="reference internal" href="non_rigid_registrars.html#base-nonrigidregistrarxy">Base NonRigidRegistrarXY</a></li>
<li class="toctree-l2"><a class="reference internal" href="non_rigid_registrars.html#base-nonrigidregistrargroupwise">Base NonRigidRegistrarGroupwise</a></li>
<li class="toctree-l2"><a class="reference internal" href="non_rigid_registrars.html#opticalflowwarper">OpticalFlowWarper</a></li>
<li class="toctree-l2"><a class="reference internal" href="non_rigid_registrars.html#simpleelastixwarper">SimpleElastixWarper</a></li>
<li class="toctree-l2"><a class="reference internal" href="non_rigid_registrars.html#simpleelastixgroupwisewarper">SimpleElastixGroupwiseWarper</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="serial_rigid.html">Serial rigid registration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="serial_rigid.html#module-valis.serial_rigid">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="serial_rigid.html#classes">Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="serial_rigid.html#zimage">ZImage</a></li>
<li class="toctree-l3"><a class="reference internal" href="serial_rigid.html#serialrigidregistrar">SerialRigidRegistrar</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="serial_non_rigid.html">Serial non-rigid registration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="serial_non_rigid.html#module-valis.serial_non_rigid">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="serial_non_rigid.html#classes">Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="serial_non_rigid.html#nonrigidzimage">NonRigidZImage</a></li>
<li class="toctree-l3"><a class="reference internal" href="serial_non_rigid.html#serialnonrigidregistrar">SerialNonRigidRegistrar</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="viz.html">Visualization</a></li>
</ul>
</div>
</section>
<section id="indices-and-tables">
<h2><a class="toc-backref" href="#id8">Indices and tables</a><a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="registration.html" class="btn btn-neutral float-right" title="Registration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, Chandler Gatenbee.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>